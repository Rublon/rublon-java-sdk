<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="refresh" content="500">
<title>Rublon Java SDK</title>


<style type="text/css">
/* GitHub stylesheet for MarkdownPad (http://markdownpad.com) */
/* Author: Nicolas Hery - http://nicolashery.com */
/* Version: b13fe65ca28d2e568c6ed5d7f06581183df8f2ff */
/* Source: https://github.com/nicolahery/markdownpad-github */

/* RESET
=============================================================================*/

html, body, div, span, applet, object, iframe, h1, h2, h3, h4, h5, h6, p, blockquote, pre, a, abbr, acronym, address, big, cite, code, del, dfn, em, img, ins, kbd, q, s, samp, small, strike, strong, sub, sup, tt, var, b, u, i, center, dl, dt, dd, ol, ul, li, fieldset, form, label, legend, table, caption, tbody, tfoot, thead, tr, th, td, article, aside, canvas, details, embed, figure, figcaption, footer, header, hgroup, menu, nav, output, ruby, section, summary, time, mark, audio, video {
  margin: 0;
  padding: 0;
  border: 0;
}

a:visited {border: none;}

/* BODY
=============================================================================*/

body {
  font-family: Helvetica, arial, freesans, clean, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  color: #333;
  background-color: #fff;
  padding: 20px;
  max-width: 960px;
  margin: 0 auto;
}

body>*:first-child {
  margin-top: 0 !important;
}

body>*:last-child {
  margin-bottom: 0 !important;
}

/* BLOCKS
=============================================================================*/

p, blockquote, ul, ol, dl, table, pre {
  margin: 15px 0;
}

/* HEADERS
=============================================================================*/

h1, h2, h3, h4, h5, h6 {
  margin: 20px 0 10px;
  padding: 0;
  font-weight: bold;
  -webkit-font-smoothing: antialiased;
}

h1 tt, h1 code, h2 tt, h2 code, h3 tt, h3 code, h4 tt, h4 code, h5 tt, h5 code, h6 tt, h6 code {
  font-size: inherit;
}

h1 {
  font-size: 28px;
  color: #000;
}

h2 {
  font-size: 24px;
  border-bottom: 1px solid #ccc;
  color: #000;
}

h3 {
  font-size: 20px;
}

h4 {
  font-size: 16px;
  font-family: Georgia, Serif;
}

h5 {
  font-size: 14px;
}

h6 {
  color: #777;
  font-size: 14px;
}

body>h2:first-child, body>h1:first-child, body>h1:first-child+h2, body>h3:first-child, body>h4:first-child, body>h5:first-child, body>h6:first-child {
  margin-top: 0;
  padding-top: 0;
}

a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 {
  margin-top: 0;
  padding-top: 0;
}

h1+p, h2+p, h3+p, h4+p, h5+p, h6+p {
  margin-top: 10px;
}

/* LINKS
=============================================================================*/

a {
  color: #4183C4;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

/* LISTS
=============================================================================*/

ul, ol {
  padding-left: 30px;
}

ul li > :first-child, 
ol li > :first-child, 
ul li ul:first-of-type, 
ol li ol:first-of-type, 
ul li ol:first-of-type, 
ol li ul:first-of-type {
  margin-top: 0px;
}

ul ul, ul ol, ol ol, ol ul {
  margin-bottom: 0;
}

dl {
  padding: 0;
}

dl dt {
  font-size: 14px;
  font-weight: bold;
  font-style: italic;
  padding: 0;
  margin: 15px 0 5px;
}

dl dt:first-child {
  padding: 0;
}

dl dt>:first-child {
  margin-top: 0px;
}

dl dt>:last-child {
  margin-bottom: 0px;
}

dl dd {
  margin: 0 0 15px;
  padding: 0 15px;
}

dl dd>:first-child {
  margin-top: 0px;
}

dl dd>:last-child {
  margin-bottom: 0px;
}

/* CODE
=============================================================================*/

pre, code, tt {
  font-size: 12px;
  font-family: Consolas, "Liberation Mono", Courier, monospace;
}

code, tt {
  margin: 0 0px;
  padding: 0px 0px;
  white-space: nowrap;
  border: 1px solid #eaeaea;
  background-color: #f8f8f8;
  border-radius: 3px;
}

pre>code {
  margin: 0;
  padding: 0;
  white-space: pre;
  border: none;
  background: transparent;
}

pre {
  background-color: #f0f0f0;
  border: 1px solid #ccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px;
}

pre code, pre tt {
  background-color: transparent;
  border: none;
}

kbd {
    -moz-border-bottom-colors: none;
    -moz-border-left-colors: none;
    -moz-border-right-colors: none;
    -moz-border-top-colors: none;
    background-color: #DDDDDD;
    background-image: linear-gradient(#F1F1F1, #DDDDDD);
    background-repeat: repeat-x;
    border-color: #DDDDDD #CCCCCC #CCCCCC #DDDDDD;
    border-image: none;
    border-radius: 2px 2px 2px 2px;
    border-style: solid;
    border-width: 1px;
    font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
    line-height: 10px;
    padding: 1px 4px;
}

/* QUOTES
=============================================================================*/

blockquote {
  border-left: 4px solid #DDD;
  padding: 0 15px;
  color: #777;
}

blockquote>:first-child {
  margin-top: 0px;
}

blockquote>:last-child {
  margin-bottom: 0px;
}

/* HORIZONTAL RULES
=============================================================================*/

hr {
  clear: both;
  margin: 15px 0;
  height: 0px;
  overflow: hidden;
  border: none;
  background: transparent;
  border-bottom: 4px solid #ddd;
  padding: 0;
}

/* TABLES
=============================================================================*/

table {width: 100%;}

caption {text-align: left; font-weight: bold;}

table th {
  font-weight: bold;
}

table th, table td {
  border: 1px solid #ccc;
  padding: 6px 13px;
}

table tr {
  border-top: 1px solid #ccc;
  background-color: #fff;
}

table tr:nth-child(2n) {
  background-color: #f8f8f8;
}

table td:first-child {width: 20%;}
table td:last-child {width: 60%;}


/* IMAGES
=============================================================================*/

img {
  max-width: 100%
}

.notice {background: #ffffcc; padding: 1em; border: 1px solid #ffe066;}

</style>

</head>
<body>
<h1>Passwordless Login by Rublon</h1>

<h2>Table of Contents</h2>

<ol>
<li><a href="#intro">Introduction</a>
<ul>
<li><a href="#intro-how-it-works">Principles of operation</a></li>
<li><a href="#intro-first-steps">First steps</a></li>
<li><a href="#intro-examples">Examples' assumptions</a></li>
<li><a href="#intro-mods">Modifying the library</a></li>
</ul></li>
<li><a href="#initialize">Library initialization</a></li>
<li><a href="#login-box">Rublon Login Box widget</a>
<ul>
<li><a href="#login-box-example">Example code</a></li>
</ul></li>
<li><a href="#auth">Initialize the authentication process</a>
<ul>
<li><a href="#auth-example">Example code</a> </li>
</ul></li>
<li><a href="#callback">Authentication finalization</a>
<ul>
<li><a href="#callback-input">Input params</a></li>
<li><a href="#callback-verification">Authentication verification</a></li>
<li><a href="#callback-example">Example code</a></li>
</ul></li>
<li><a href="#strategies">Authentication strategies</a>
<ul>
<li><a href="#strategies-profile-id">By profile ID</a></li>
<li><a href="#strategies-email">By email address</a></li>
</ul></li>
</ol>

<p><a id="intro"></a></p>

<h2>Introduction</h2>

<p>The <em>Rublon Passwordless Login</em> is an implementation of the authentication process
based on the Rublon SDK library where the user's login or password inputs are not
required at all.</p>

<p>Rublon provides an authentication system based on the Rublon Mobile App
which works as the authentication token.</p>

<p>The end-user should install the Rublon mobile app, available on all leading
smartphone systems.</p>

<p><a id="intro-how-it-works"></a></p>

<h3>Principles of operation</h3>

<h4>Displaying the Rublon Login Box</h4>

<p>Instead of a login form you need to display the Rublon Login Box widget
which will display a login button.</p>

<p>An URL address pointing to Rublon servers will be generated from the SDK library.
The user's web browser must be then redirected
to that URL in order to carry out the authentication process.</p>

<h4>Return to the integrated system</h4>

<p>After a successful authentication, the web browser will be redirected to
a callback URL address which points to the integrated system servers.
The integrated system should intercept that URL, retrieve its params and finalize
the authentication using this library.</p>

<p><a id="intro-first-steps"></a></p>

<h3>First steps</h3>

<p>To start using the Rublon Passwordless Login you should:</p>

<ul>
    <li>
        install the Rublon mobile app on your smartphone,
        create a new account and confirm your email address,
    </li>
    <li>
        visit the <a href="https://admin.rublon.net">Rublon Admin Console</a>
        and log,
    </li>
    <li>
        go to the "Add the application" form (Applications -> Add)
        and fill in the required fields (<em>URL</em> and <em>Type</em>: Custom integration using Java SDK),
    </li>
    <li>
        copy the provided <strong>system token</strong> and <strong>secret key</strong>,
        which will be used to identify the integrated system and verify
        the authenticity and integrity of the messages exchanged with Rublon API.
    </li>
</ul>

<p><a id="intro-examples"></a></p>

<h3>Examples' assumptions</h3>

<p>In the following examples we assume the existence of:
*   the session handler class <code>Session</code>, which has access to
    an object storing the currently logged in user data,
*   the <code>HttpServer</code> class which is a simple HTTP server instance,
*   the <code>Database</code> class which is a database interface.</p>

<p><a id="intro-mods"></a></p>

<h3>Modifying the library</h3>

<p>The <code>Rublon</code> class implements a few public methods, which, when needed,
can be overriden with inheritance.</p>

<p>We strongly discourage you from modifying any part of the library, as it usually
leads to difficulties during future library updates. If you need to change the flow
or internal structure of the <code>Rublon</code> or <code>RublonCallback</code>
classes, don't hesitate to subclass them according to your needs.</p>

<p><a id="initialize"></a></p>

<h2>Library initialization</h2>

<p>To initialize the library you need to instantiate a <code>Rublon</code> class object.
Its constructor takes three arguments.</p>

<table>
    <caption><code>Rublon</code> class constructor arguments</caption>
    <thead><tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
    </tr></thead>
    <tbody>
        <tr><td><code>systemToken</code></td><td>String</td><td>Your system's public Id</td></tr>
        <tr><td><code>secretKey</code></td><td>String</td><td>Secret key</td></tr>
        <tr><td><code>apiServer</code></td><td>String</td><td>(optional) API Server URL or other custom URL</td></tr>
    </tbody>
</table>

<p>An example of the library's initialization:</p>

<pre><code>    import com.rublon.sdk.login.Rublon;

    ...

    Rublon rublon = new Rublon(
        //unique system token:
        "A69FC450848B4B94A040416DC4421523",
        //unique secret key:
        "bLS6NDP7pGjg346S4IHqTHgQQjjSLw3CyApvz5iRjYzgIPN4e9EOi1cQJLrTlvLoHY8zeqg4ILrItYidKJ6JjEUZaA6pR1tZMwSZ"
    );
</code></pre>

<p><a id="login-box"></a></p>

<h2>Rublon Login Box widget</h2>

<p>Developer has to embed on his website the Rublon Login Box widget which
allows a user to choose the authentication by the existing Trusted Device(s)
or login as a new user. Developer must provide to the Login Box an URL address
to his website's endpoint which will be responsible for initialize
the authentication transaction using the Rublon SDK library and
redirect the user's web browser to the Rublon server in order
to authenticate himself.</p>

<p><a id="login-box-example"></a></p>

<h3>Example code</h3>

<p>Following code shows how to embed the Rublon Login Box widget.</p>

<pre><code>// URL of the authentication endpoint:
String authUrl = "http://example.com/auth/rublon/init";

// Construct the Rublon instance:
Rublon rublon = new Rublon(
    //unique systemToken (please store in a config):
    "A69FC450848B4B94A040416DC4421523",
    //unique secretKey (please store in a safe config):
    "bLS6NDP7pGjg346S4IHqTHgQQjjSLw3CyApvz5iRjYzgIPN4e9EOi1cQJLrTlvLoHY8zeqg4ILrItYidKJ6JjEUZaA6pR1tZMwSZ"
);

// Embed the Login Box widget:
HttpServer.sendOutput(rublon.getWidget());
</code></pre>

<p><a id="auth"></a></p>

<h2>Initialize the authentication process</h2>

<p>The <code>Rublon.auth()</code> method will check the Rublon server's status
and return an URL address for the web browser to be redirected to.</p>

<table>
    <caption><code>Rublon.auth()</code> method arguments</caption>
    <thead><tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
    </tr></thead>
    <tbody>
        <tr>
            <td><code>callbackUrl</code></td>
            <td>String</td>
            <td>The integrated system's callback URL</td>
        </tr>
        <tr>
            <td><code>appUserId</code></td>
            <td>String</td>
            <td>The integrated system's user's unique ID, which will allow to log in the user upon successful
                authentication
            </td>
        </tr>
        <tr>
            <td><code>userEmail</code></td>
            <td>String</td>
            <td>The user's email address in the integrated system, which will allow to check the user's protection status
                and
                match the user to a Rublon account
            </td>
        </tr>
        <tr>
            <td><code>consumerParams</code></td>
            <td>JSONObject</td>
            <td>Additional transaction parameters (optional)</td>
        </tr>
        <tr>
            <td><code>isPasswordless</code></td>
            <td>boolean</td>
            <td>Information if it is a login attempt using passwordless method (optional)</td>
        </tr>
    </tbody>
</table>

<p><a id="auth-example"></a></p>

<h3>Example code</h3>

<p>An example of logging in a user on an integrated system:</p>

<pre><code>/**
 * An example method used to log the user in.
 */
void rublonLogin() {

    Rublon rublon = new Rublon(
        // systemToken (please store in a config):
        "A69FC450848B4B94A040416DC4421523",
        // secretKey (please store in a safe config):
        "bLS6NDP7pGjg346S4IHqTHgQQjjSLw3CyApvz5iRjYzgIPN4e9EOi1cQJLrTlvLoHY8zeqg4ILrItYidKJ6JjEUZaA6pR1tZMwSZ"
    );

    try { // Initiate a Rublon authentication transaction

        String url = rublon.auth(
            "http://example.com/auth/rublon/callback", // callback URL
            "", // user email
            "", // The integrated system's user's unique ID
            new JSONObject(), // Additional transaction parameters
            true // Type of Passwordless login
        );

        if (url != null) {

            // Log the user out:
            Session.setUser(null);

            // Redirect the user's web browser to Rublon servers
            // to authenticate the user by Rublon:
            HttpServer.sendHeader("Location", url);

        } else {
            // Rublon may be not available.
        }

    } catch (RublonException e) {
        // An error occurred
        Session.setUser(null);
        HttpServer.setStatus(500);
        HttpServer.setResponse("There was an error, please try again later.");
    }

}
</code></pre>

<p>Calling the <code>Rublon.auth()</code>
method will return a URL address pointing to Rublon servers, which the user's
browser should redirect to in order to verify a Trusted Device or display
a QR code to be scanned by the Rublon mobile app.</p>

<p><a id="callback"></a></p>

<h2>Authentication finalization</h2>

<p>After a successful authentication Rublon will redirect the user's browser
to the callback URL. The callback flow continues the authentication process,
i.e. the finalization of the authentication (logging in).</p>

<p><a id="callback-input"></a></p>

<h3>Input params</h3>

<p>The callback URL will receive its input arguments in the URL address itself (<em>query string</em>).</p>

<table>
    <caption>Callback URL arguments</caption>
    <thead><tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
    </tr></thead>
    <tbody>
        <tr><td><code>rublonState</code></td><td>String</td><td>Authentication result: <code>ok</code>, <code>error</code> or <code>cancel</code></td></tr>
        <tr><td><code>rublonToken</code></td><td>String</td><td>Access token (100 alphanumeric characters, upper- and lowercase), which allows authentication's verification using a background Rublon API connection</td></tr>
    </tbody>
</table>

<div class="block">
Notice: If the callback URL has been set to e.g. <code>http://example.com/auth/rublon/callback/</code>,
the params will be appended to the URL address:
<pre><code>http://example.com/auth/rublon/callback/?rublonState=ok&rublonToken=Kmad4hAS...d</code></pre>
If your callback URL should be formed differently (e.g. when using an URL rewrite),
you can set the callback URL's template using the meta-tags:
<code>%rublonTtoken%</code> and <code>%rublonState%</code>, like so:<br />
<pre><code>http://example.com/auth/rublon/callback/%rublonState%/%rublonToken%</code></pre>
</div>

<p><a id="callback-verification"></a></p>

<h3>Authentication verification</h3>

<p>After the callback is invoked, for proper finalization of the authentication
process you need to create a <code>RublonCallback</code> subclass instance.
Because the <code>RublonCallback</code> class in abstract you need to create a subclass
that implement needed methods which depend on your system details.</p>

<table>
    <caption><code>RublonCallback</code> class constructor method arguments</caption>
    <thead><tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
    </tr></thead>
    <tbody>
        <tr><td><code>rublon</code></td><td>Rublon</td><td>An instance of the <code>Rublon</code> class.</td></tr>
    </tbody>
</table>

<p>Next, the <code>RublonCallback.call()</code> method should be called.</p>

<p>The following abstract methods should be implemented in a subclass.</p>

<ul>
<li><code>String getState()</code> - returns the "rublonState" parameter from the HTTP GET request.</li>
<li><code>String getAccessToken()</code> - returns the "rublonToken" parameter from the HTTP GET request.</li>
<li><code>void handleCancel()</code> - called when the state parameter is not "ok" nor "error".</li>
<li><code>void handleError()</code> - called when the state parameter value is "error".</li>
<li><code>void userAuthenticated(String profileId)</code> - handle the authenticated user.</li>
</ul>

<p><a id="callback-example"></a></p>

<h3>Example code</h3>

<p>An example implementation of the <code>RublonCallback</code> class and usage in the callback:</p>

<pre><code>class Callback extends RublonCallback {
    public String getState() {
        return HttpServer.getRequestHandler().getParam(PARAMETER_STATE);
    }
    public String getAccessToken() {
        return HttpServer.getRequestHandler().getParam(PARAMETER_ACCESS_TOKEN);
    }
    protected void handleCancel() {
        HttpServer.sendHeader("Location", "/login");
    }
    protected void handleError() {
        HttpServer.sendHeader("Location", "/login?msg=rublon-error");
    }
    protected void userAuthenticated(String profileId) {
        User user = User.getByField("rublon_profile_id", profileId);
        if (user != null) {
            Session.setUser(user);
            HttpServer.sendHeader("Location", "/dashboard");
        } else {
            HttpServer.sendHeader("Location", "/login?msg=rublon-error");
        }
    }
}

...

Rublon rublon = new Rublon(
    "A69FC450848B4B94A040416DC4421523",
    "bLS6NDP7pGjg346S4IHqTHgQQjjSLw3CyApvz5iRjYzgIPN4e9EOi1cQJLrTlvLoHY8zeqg4ILrItYidKJ6JjEUZaA6pR1tZMwSZ"
);

try {

    RublonCallback callback = new RublonCallback(rublon);
    callback.call();

} catch (CallbackException e) {
    // Please handle this error in the better way:
    HttpServer.setStatus(500);
    HttpServer.setResponse("There was an error, please try again later. " + e.getMessage());
}
</code></pre>

<p><a id="strategies"></a></p>

<h2>Authentication strategies</h2>

<p>There are two general authentication strategies that can be used
by the developer to login the user in his system
after the user has been authenticated by Rublon.</p>

<p><a id="strategies-profile-id"></a></p>

<h3>By profile ID</h3>

<p>First, user has to login to his existing account in the normal way e.g. by
using login and password. Then the Rublon authentication process should be
invoken, for example after user clicks on a "Link with Rublon" button.
After the user will authenticate by Rublon, his Rublon user's profile ID
will be available in the callback method. Then your system should
save this profile ID linked with your user's local ID in your database.</p>

<p>The following code shows an example implementation of
the RublonCallback.userAuthenticated() abstract method
which implements the profile-ID-match strategy.</p>

<pre><code>protected void userAuthenticated(String profileId) {

    User user = User.getByField("rublon_profile_id", profileId);
    if (user != null) {

        // User has been recognized.
        Session.setUser(user);
        HttpServer.sendHeader("Location", "/dashboard");

    } else {

        // There's no user linked with this profile ID.

        // Check if user wants to link his account with Rublon:
        User currentUser = Session.getUser();
        if (currentUser != null) {
            currentUser.setMetaField("rublon_profile_id", profileId);
        } else {
            HttpServer.sendHeader("Location", "/login?msg=rublon-error");
        }

    }
}
</code></pre>

<p>When the user's account has been linked with the Rublon profile ID
in your database, you will be able to recognize the local user's
account after the user will authenticate by Rublon next time
as shown in the example above.</p>

<p><a id="strategies-email"></a></p>

<h3>By email address</h3>

<p>The second strategy is to match a local user by his email address
from Rublon. In the callback method the Rublon SDK library returns
the <code>Credentials</code> instance which provides the user's
email addresses list which has been entered by user to Rublon.
Each email address is not given as a plain-text, but it is the SHA-256 hash
of the lower-case email address.</p>

<p>In order to optimize matching you should create an indexed database column,
next to the user's email column, which stores the actual SHA-256
hash of the user's current email address. Then you will be able
to select users that matches with the provided hash list after
the user has been authenticated by Rublon.</p>

<p>The following code shows an example implementation of
the RublonCallback.userAuthenticated() abstract method
which implements the email-match strategy.</p>

<pre><code>protected void userAuthenticated(String profileId) {

    String[] emails = getUserEmailHashArray();
    User[] users = User.selectByMetaField("email_sha256", emails);
    if (users.length == 0) {
        HttpServer.sendHeader("Location", "/login?msg=missing-user");
    }
    else if (users.length == 1) {
        Session.setUser(users[0]);
        HttpServer.sendHeader("Location", "/dashboard");
    } else {
        // More users have been matched, you have to implement the solution.
    }

}
</code></pre>
</body></html>
